---
title: 'Survival Data Analysis HW #1'
author: "Brendan Graham"
date: "June 20, 2016"
output: word_document
---

```{r setup, include=FALSE}
library(survival)
library(OIsurv)
library(KMsurv)
library(km.ci)
library(locfit)
library(dplyr)
library(survMisc)

#load data 
wha <- read.table(file = "https://raw.githubusercontent.com/brndngrhm/survival_analysis/master/data/whas500.txt", 
                  header = T)
wha <- wha %>% select(age, gender, lenfol, fstat)
```

### 2.
#### a)
 
```{r, echo=T, fig.height=8, fig.width=8}
wha.surv <- Surv(wha$lenfol, wha$fstat)
fit <- survfit(wha.surv~1)
surv.plot <- plot(fit, conf.int = T, xlab = "Number of days followed since MI",
             ylab = "Survival Probability", main = "K-M Survival Curve of Heart Attack Survivors")
conf.bands <- km.ci(fit, method="loghall")
lines(conf.bands, lty=3)
legend(500, .4, c("K-M Curve", "Pointwise CI", "Simultaneous CB"), lty=c(1,2,3))
```

#### b) 
The estimated survival curve does not appear to be headed towards zero as time goes to infinity. The curve seems to be leveling-off around .40 to .50 at around 1,500 days.


#### c)

```{r, echo=T}
quantile(fit, probs = c(.25, .5, .75))
```

To obtain the 95% confidence interval for the 50th percentile, R looks for every value of t such that the point-wise confidence interval for S(t) includes 0.50. In this case, the lower bound is t=1527, which has a 95% CI of (0.4958, 0.598). The next lowest time, t=1506 has a 95% CI of (0.5020, 0.602), which does not include 0.50, so the lower bound stopped at t=1527. Every CI for values of t > 1527 includes 0.50 which is why there is no upper bound reported by R for the 95% confidence interval for the 50th percentile.

#### d)
The mean survival time for men is 1448.5 and the mean survival time for women is 1260.2.  

```{r, echo=T}
#split into men and women dataframes
men <- wha %>% filter(gender == 0)
women <- wha %>% filter(gender == 1)

#mean survival time for men
men.surv <- Surv(men$lenfol, men$fstat)
fit.men <- survfit(men.surv~1)
print(fit.men, print.rmean =T)

#mean survival time for women
women.surv <- Surv(women$lenfol, women$fstat)
fit.women <- survfit(women.surv~1)
print(fit.women, print.rmean =T)
```

At t=1000, the mean residual lifetime for men is  1060.4 and for women, it is 1063.8.
```{r, echo=T}
#mrlife function
mrlife <- function(t, event, censoring){
  kmfit <- survfit(Surv(event[event>t]-t, censoring[event>t])~1, conf.type="log-log")
  print(kmfit, print.rmean = T)
}

#Mean Residual lifetime for Men at time 1000
mrlife(1000, wha$lenfol[wha$gender == 0], wha$fstat[wha$gender == 0])

#Mean Residual lifetime for Women at time 1000 
mrlife(1000, wha$lenfol[wha$gender == 1], wha$fstat[wha$gender == 1])
```

It seemed strange that males have a higher mean survival time, while women have a higher mean residual lifetime at t=1000, so I calculated and plotted the mean residual lifetimes for each gender and plotted them. I seems that at around t=1000 mean residual life for women is slightly higher than that for men.

```{r, echo=T, fig.height=8, fig.width=8}
mrl.men <- km.mrl(men$lenfol, abs(men$fstat-1))[men$fstat == 0]
time.men <- men$lenfol[men$fstat == 0]
mrl.men <- cbind(mrl.men, time.men)
mrl.men <- data.frame(mrl.men) %>% arrange(time.men)

mrl.women <- km.mrl(women$lenfol, abs(women$fstat-1))[women$fstat == 0]
time.women <- women$lenfol[women$fstat == 0]
mrl.women <- cbind(mrl.women, time.women)
mrl.women <- data.frame(mrl.women) %>% arrange(time.women)

plot(mrl.women$time.women, mrl.women$mrl.women, ylab="Mean Resid. Life", xlab="Time", main="Mean Residual Life by Gender", col="Red",
     xlim = c(min(mrl.women$time.women, mrl.men$time.men), max(mrl.women$time.women, mrl.men$time.men)), 
     ylim = c(c(min(mrl.women$mrl.women, mrl.men$mrl.men), max(mrl.women$mrl.women, mrl.men$mrl.men))))
points(mrl.men$time.men, mrl.men$mrl.men, col="Blue")
legend(500,500, c("Women", "Men"), lty=c(1,1), col=c("Red", "Blue"))

```


#### e)
The survival curves for men and women shows the survival curve for men is higher than he survival curve for women.
```{r, echo=T, fig.height=8, fig.width=8}
plot(fit.men, conf.int = F, main="Survival Curves for Men and Women", ylab="Survival probability", xlab="Number of days followed since MI", col="Blue", lwd=2)
lines(fit.women, conf.int = F, lwd=2, col="red")
legend(500, .4, c("Male", "Female"), lwd = c(1,2), col=c("Blue", "red"))
```

#### f)
Ho: S~male~(t) = S~female~(t)  
Ha: S~male~(t) != S~female~(t)
```{r, echo=T}
fit.gender <- survfit(wha.surv ~ gender, data=wha)
fit <- ten(fit.gender)
comp(fit)
```
Since the survival curve for men and women do not cross we can just look at the results in the first table. Results in the first table from the 6 tests all show a significant difference between the male and females curves at at the .05 level. Therefore we reject the null and conclude the alternative. We have enough evidence to conclude there is a difference between the survival curves for men and women at the .05 level. Based on the survival plots in part (e), males have higher survival probability.

#### g)
Ho: S~50 or less~(t) = S~Between 50 and 75~(t) = S~75 or Greater~(t)  
Ha: At least 2 equalities in Ho are not true

```{r, echo=T, fig.height=8, fig.width=8}
wha$age2 <- 2
wha$age2[wha$age <= 50] <- 1
wha$age2[wha$age >= 75] <- 3

fit.age <- ten(survfit(Surv(wha$lenfol, wha$fstat) ~ age2, data=wha))
comp(fit.age, data = wha)
```
The results in the first table from the 6 tests all indicate very high chi-square values. Therefore we reject the null and conclude the alternative. We have enough evidence at the .05 level to conclude there is a difference between the survival curves for the three age groups (50 or less, Between 50 and 75, 75 or Greater). Since there is a difference in the curves we can conduct a trend test:

Ho: There is a trend present in the survival curves
Ha: There is not a trend present in the survival curves

```{r, echo=T}
wha2 <- wha %>% arrange(lenfol)
cbind(fit.age$cg, unique(cbind(wha2$lenfol,wha2$age2)))[1:10,]
comp(fit.age, scores=c(3, 2, 1), data=wha)
```

Given the high chi-square values shown in the test output, we can reject the null and conclude the alternative. We have enough evidence at the .05 level to conclude there is a trend present. To visualize the trend, below is a plot of the three survival curves by age category.
```{r, echo=T, fig.height=8, fig.width=8}
wha$age2 <- "Between 50 and 75"
wha$age2[wha$age <= 50] <- "50 or less"
wha$age2[wha$age >= 75] <- "75 or Greater"

fit.low <- survfit(Surv(wha$lenfol[wha$age2 == "50 or less"], wha$fstat[wha$age2 == "50 or less"])~1, conf.type = "log-log")
fit.med <- survfit(Surv(wha$lenfol[wha$age2 == "Between 50 and 75"], wha$fstat[wha$age2 == "Between 50 and 75"])~1, conf.type = "log-log")
fit.high <- survfit(Surv(wha$lenfol[wha$age2 == "75 or Greater"], wha$fstat[wha$age2 == "75 or Greater"])~1, conf.type = "log-log")
plot(fit.high, conf.int = F, main="Heart Attack Survival Curves by Age Category", xlab="Number of days followed since MI", ylab="Survival Probability", lwd=2, col="purple")
lines(fit.med, conf.int = F, col="Red", lwd=2)
lines(fit.low, conf.int = F, col="Blue", lwd=2)
legend(500, .2, c("Greater than 75", "Between 50 and 75","50 or less"), lwd=c(2,2,2), col=c("Purple", "Red", "Blue"))
```

